<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de entradas</title>
    <link rel="stylesheet" href="CSS/estilo.css">
    <link rel="stylesheet" href="https://static.puntoticket.com/especiales/landing-common/css/bootstrap.css">
    <link rel="stylesheet" href="https://static.puntoticket.com/especiales/landing-common/css/main-2023.css">
    <link rel="stylesheet" href="https://static.puntoticket.com/especiales/landing-common/css/aos.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="IMG/21-Pilots-Logo-2019.png">
</head>
<style>
    body{
        background-image: url(IMG/34thEAx.jpg);
        background-attachment: fixed;
    }
</style>
<body>
    <!-- Modal para ver detalles -->
    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="detallesModalLabel">Detalles del Usuario</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detallesUsuario">
                    <p id="rut-label">Rut: <span id="rut"></span></p>
                    <br>
                    <p id="nombre-label">Nombre: <span id="nombre"></span></p>
                    <br>
                    <p id="edad-label">Edad: <span id="edad"></span></p>
                    <br>
                    <p id="cantidadDeEntradas-label">Cantidad de entradas: <span id="cantidadDeEntradas"></span></p>
                    <br>
                    <p id="fecha-label">Fecha: <span id="fecha"></span></p>
                    <br>
                    <p id="asiento-label">Asiento: <span id="asiento"></span></p>
                    <br>
                    <p id="imagen-label">Carnet: <span id="imagen"></span></p>
                    <br>
                    <img id="imagen-carnet" src="" alt="Imagen del Carnet" style="max-width: 100%; height: auto;">
                </div>
            </div>            
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
        </div>
    </div>
    <!-- Modal para confirmar eliminación -->
    <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="eliminarModalLabel">Confirmar Eliminación</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar este usuario?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarEliminarBtn" data-id="">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <div class="principalContainer">
        <div class="container">
            <header>
                <h1>Twenty One Pilots</h1>
                <nav>
                    <ul>
                        <li><a href="home.html">Inicio</a></li>
                        <li><a href="songs.html">Canciones</a></li>
                        <li><a href="ubicacion.html">Ubicación</a></li>
                        <li id="tabla-entradas" style="display: none;"><a href="listarEntradas.html">Tabla Entradas</a></li>
                        <li class="logout-container"><a href="/logout" class="button">Cerrar Sesión</a></li>
                    </ul>
                </nav>
            </header>
            <h2 class="tablaTitulo">Entradas</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rut</th>
                        <th>Nombre</th>
                        <th>Edad</th>
                        <th>Cantidad de entradas</th>
                        <th>Fecha</th>
                        <th>Asiento</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="entradasCompradas-list"></tbody>
            </table>
            <script>
                fetch('/getUserSession')
                    .then(response => response.json())
                    .then(data => {
                        if (data.rol != 1) {
                            window.location.href = 'home.html';
                        } else {
                            loadEntradas();
                        }
                    });

                    function loadEntradas() {
                    fetch('/entradasCompradas')
                        .then(function(response) {
                        return response.json();
                        })
                        .then(function(data) {
                        var entradasCompradasList = document.getElementById('entradasCompradas-list');
                        entradasCompradasList.innerHTML = '';
                        data.forEach(function(entradas) {
                            var row = document.createElement('tr');
                            row.innerHTML = '<td>' + entradas.Rut + '</td>' +
                                            '<td>' + entradas.nombre + '</td>' +
                                            '<td>' + entradas.edad + '</td>' +
                                            '<td>' + entradas.cantidadDeEntradas + '</td>' +
                                            '<td>' + new Date(entradas.Fecha).toLocaleDateString() + '</td>' +
                                            '<td>' + entradas.Asiento + '</td>' +
                                            '<td>' +
                                                "<button class='btn btn-info btn-sm' onclick='verDetalles(" + entradas.id + ")' data-bs-toggle='modal' data-bs-target='#detallesModal'>Ver detalles</button>" +
                                            '</td>' +
                                            '<td>' +
                                                "<button class='btn btn-danger btn-sm' onclick='eliminarEntrada(" + entradas.id + ")' data-bs-toggle='modal' data-bs-target='#eliminarModal'>Eliminar</button>" +
                                            '</td>' +
                                            '<td>'  +
                                                '<button onclick="modificarEntrada(' + entradas.id + ')">Modificar</button>' +
                                            '</td>';
                            entradasCompradasList.appendChild(row);
                        });
                        });
                    }

                let entradaId = null;

                function eliminarEntrada(id) {
                entradaId = id;
                $('#eliminarModal').modal('show');
                }

                document.getElementById('confirmarEliminarBtn').addEventListener('click', function() {
                if (entradaId!== null) {
                    fetch('/eliminar_entrada/' + entradaId, {
                    method: 'DELETE'
                    })
                .then(function(response) {
                    return response.text();
                    })
                .then(function(data) {
                    loadEntradas();
                    var eliminarModal = document.getElementById('eliminarModal');
                    bootstrap.Modal.getInstance(eliminarModal).hide();
                    });
                    entradaId = null;
                }
                });

                function verDetalles(id) {
                fetch('/verDetalles/' + id)
                    .then(response => response.json())
                    .then(data => {
                        const detallesUsuario = document.getElementById('detallesUsuario');
                        detallesUsuario.innerHTML = '';

                        const table = document.createElement('table');
                        table.style.backgroundColor = 'white';
                        detallesUsuario.appendChild(table);

                        const tableBody = document.createElement('tbody');
                        tableBody.className = 'detalles-tbody';
                        table.appendChild(tableBody);

                        const rows = [
                            ['Rut:', data.rut],
                            ['Nombre:', data.nombre],
                            ['Edad:', data.edad],
                            ['Cantidad de entradas:', data.cantidadDeEntradas],
                            ['Fecha:', new Date(data.fecha).toLocaleDateString()],
                            ['Asiento:', data.Asiento]
                        ];

                        rows.forEach(row => {
                            const tableRow = document.createElement('tr');
                            tableBody.appendChild(tableRow);

                            const tableCellLabel = document.createElement('td');
                            tableCellLabel.innerHTML = row[0];
                            tableRow.appendChild(tableCellLabel);

                            const tableCellValue = document.createElement('td');
                            tableCellValue.innerHTML = row[1];
                            tableRow.appendChild(tableCellValue);
                        });

                        const carnetRow = document.createElement('tr');
                        tableBody.appendChild(carnetRow);

                        const carnetLabel = document.createElement('td');
                        carnetLabel.innerHTML = 'Carnet:';
                        carnetRow.appendChild(carnetLabel);

                        const carnetValue = document.createElement('td');
                        carnetRow.appendChild(carnetValue);

                        const carnetImage = document.createElement('img');
                        carnetImage.src = 'imagenes/' + data.imagenCarnet;
                        carnetImage.alt = 'Imagen del Carnet';
                        carnetImage.style.maxWidth = '100%';
                        carnetImage.style.height = 'auto';
                        carnetValue.appendChild(carnetImage);

                        console.log('Image path:', carnetImage.src);
                    })
                    .catch(error => console.error('Error fetching details:', error));
            }

                function modificarEntrada(id) {
                    window.location.href = '/modificarEntrada.html?id=' + id;
                }
            </script>
        </div>
        
    </div>

    <script>
        fetch('/getUserSession')
            .then(response => response.json())
            .then(data => {
                if (!data.correo) {
                    window.location.href = 'index.html';
                } else if (data.rol == 1) {
                    document.getElementById('tabla-entradas').style.display = 'inline';
                }
            })
            .catch(error => {
                console.error('Error al verificar la sesión:', error);
                window.location.href = 'index.html';
            });
    </script>
</body>
</html>